<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Blink â€” MediaPipe</title>
<style>
  :root{--bg:#fbfbfb;--muted:#666}
  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:#111;
  }
  body{display:flex;flex-direction:column;align-items:center;justify-content:flex-start}
  .topbar{
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:14px 0 10px;
    gap:8px;
    box-sizing:border-box;
  }
  h1{margin:0;font-size:18px;font-weight:600;text-align:center}
  .controls{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
  #startBtn{
    padding:12px 18px;
    font-size:16px;
    border-radius:10px;
    border:0;
    background:#111;
    color:#fff;
    cursor:pointer;
  }
  .wrap{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:16px;
    width:100%;
  }
  .sq{
    width:110px;height:92px;
    border-radius:12px;
    background:#111;
    color:#fff;
    font-weight:700;
    font-size:14px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 8px 20px rgba(12,12,12,.12);
    transition:background-color .14s ease,transform .14s ease;
  }
  .sq.flash{transform:translateY(-6px) scale(1.03);box-shadow:0 18px 34px rgba(12,12,12,.18)}
  #videoEl{display:none}
  canvas{display:none}
  #status,#errorBox,pre#debug{display:none!important}
  @media(max-width:420px){
    .sq{width:92px;height:74px;font-size:12px}
    #startBtn{font-size:15px}
  }
</style>
</head>
<body>
  <div class="topbar">
    <h1>Blink Detector</h1>
    <div class="controls">
      <button id="startBtn">Start camera</button>
    </div>
  </div>

  <div class="wrap">
    <div id="bothSq" class="sq">BOTH</div>
  </div>

  <video id="videoEl" autoplay playsinline muted></video>
  <canvas id="hiddenCanvas"></canvas>

<script>
const startBtn=document.getElementById('startBtn');
const bothSq=document.getElementById('bothSq');
const videoEl=document.getElementById('videoEl');

const COLORS={none:'#111',both:'#ffd36b'};
const flashTimeouts=new WeakMap();
function flashElement(el,color,ms=260){
  if(!el)return;
  const prev=flashTimeouts.get(el);
  if(prev)clearTimeout(prev);
  el.style.background=color;
  el.classList.add('flash');
  const t=setTimeout(()=>{
    el.style.background='';
    el.classList.remove('flash');
    flashTimeouts.delete(el);
  },ms);
  flashTimeouts.set(el,t);
}

// landmark helpers
const LEFT_EYE_INDICES=[33,160,158,133,153,144];
const RIGHT_EYE_INDICES=[362,385,387,263,373,380];
function toPoint(p){if(!p)return{x:0,y:0};if(Array.isArray(p))return{x:p[0],y:p[1]};return{x:p.x,y:p.y};}
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy);}
function computeEAR(landmarks,idxs){
  const p1=toPoint(landmarks[idxs[0]]),p2=toPoint(landmarks[idxs[1]]),p3=toPoint(landmarks[idxs[2]]),
        p4=toPoint(landmarks[idxs[3]]),p5=toPoint(landmarks[idxs[4]]),p6=toPoint(landmarks[idxs[5]]);
  const A=dist(p2,p6),B=dist(p3,p5),C=dist(p1,p4)||1e-6;
  return (A+B)/(2*C);
}

// file mapper
function locateFileMapper(file){
  const lname=String(file).toLowerCase();
  if(lname.includes('simd')&&lname.includes('.wasm'))
    return '/libs/mediapipe/face_mesh_solution_simd_wasm_bin.wasm';
  if(lname.includes('.wasm'))
    return '/libs/mediapipe/face_mesh_solution_wasm_bin.wasm';
  return '/libs/mediapipe/'+file;
}

// vars
let faceMeshInstance=null;
let running=false;
let closingLeft=false,closingRight=false;
let EAR_THRESHOLD=0.18;

async function ensureFaceMeshClass(){
  if(window.FaceMesh&&typeof window.FaceMesh==='function')return window.FaceMesh;
  try{
    await new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src='/libs/face_mesh.js';s.async=true;
      s.onload=res;s.onerror=rej;
      document.head.appendChild(s);
    });
    if(window.FaceMesh)return window.FaceMesh;
  }catch(e){}
  const mod=await import('/libs/face_mesh.js');
  const cands=[mod.default,mod.FaceMesh,mod.MPFaceMesh,mod.FaceMeshModule];
  for(const c of cands)if(typeof c==='function')return c;
  throw new Error('FaceMesh not found');
}

async function initFaceMesh(ClassFaceMesh){
  faceMeshInstance=new ClassFaceMesh({locateFile:(f)=>locateFileMapper(f)});
  faceMeshInstance.setOptions({
    maxNumFaces:1,
    refineLandmarks:true,
    minDetectionConfidence:0.5,
    minTrackingConfidence:0.5
  });
  faceMeshInstance.onResults(onFaceMeshResults);
}

function onFaceMeshResults(res){
  if(!res||!res.multiFaceLandmarks||res.multiFaceLandmarks.length===0)return;
  const lm=res.multiFaceLandmarks[0];
  const leftEAR=computeEAR(lm,LEFT_EYE_INDICES);
  const rightEAR=computeEAR(lm,RIGHT_EYE_INDICES);
  const leftClosed=leftEAR<EAR_THRESHOLD;
  const rightClosed=rightEAR<EAR_THRESHOLD;
  if(leftClosed)closingLeft=true;
  if(rightClosed)closingRight=true;
  if(!leftClosed&&!rightClosed&&(closingLeft||closingRight)){
    flashElement(bothSq,COLORS.both);
    closingLeft=closingRight=false;
  }
}

async function detectLoop(){
  running=true;
  while(running){
    if(videoEl.readyState>=2&&faceMeshInstance){
      await faceMeshInstance.send({image:videoEl});
    }
    await new Promise(r=>requestAnimationFrame(r));
  }
}

startBtn.addEventListener('click',async()=>{
  startBtn.disabled=true;
  try{
    const stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'user',width:{ideal:640},height:{ideal:480}},
      audio:false
    });
    videoEl.srcObject=stream;
    await new Promise(r=>(videoEl.onloadedmetadata=r));
  }catch(err){alert('Camera error');startBtn.disabled=false;return;}
  try{
    const FaceMeshClass=await ensureFaceMeshClass();
    await initFaceMesh(FaceMeshClass);
    await detectLoop();
  }catch(err){alert('Init failed');startBtn.disabled=false;}
});
</script>
</body>
</html>