async function startCameraWithFallback() {
  const statusEl = document.getElementById('status'); // optional UI element
  statusEl && (statusEl.textContent = 'Requesting camera (tap allow)…');

  // first try simple, robust constraints
  const tryConstraints = [
    { video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } } },
    { video: true } // fallback
  ];

  for (const c of tryConstraints) {
    try {
      // MUST be called inside a user gesture (click/tap)
      const stream = await navigator.mediaDevices.getUserMedia(c);
      // success
      const video = document.getElementById('videoEl');
      if (video) {
        video.srcObject = stream;
        await video.play().catch(()=>{ /* some browsers require playsinline/muted for autoplay */ });
      }
      statusEl && (statusEl.textContent = 'Camera started');
      return stream;
    } catch (err) {
      console.warn('getUserMedia error for', c, err);
      // show friendly message
      if (err.name === 'NotAllowedError' || err.name === 'SecurityError') {
        statusEl && (statusEl.textContent = 'Camera permission denied — open Safari site settings (tap aA → Website Settings) and allow Camera for this site.');
        // stop trying further — user/UA blocked
        return null;
      } else if (err.name === 'OverconstrainedError' || err.name === 'ConstraintNotSatisfiedError') {
        // try next fallback constraint
        statusEl && (statusEl.textContent = 'Device constraints not supported — falling back...');
        continue;
      } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
        statusEl && (statusEl.textContent = 'Camera is busy or unavailable. Close other apps/tabs and try again.');
        return null;
      } else {
        statusEl && (statusEl.textContent = `Camera error: ${err.name}. See console for details.`);
        return null;
      }
    }
  }
  statusEl && (statusEl.textContent = 'Unable to start camera.');
  return null;
}

// usage: call inside a click handler
document.getElementById('startBtn').addEventListener('click', async (e) => {
  await startCameraWithFallback();
});